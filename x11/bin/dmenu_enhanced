#!/usr/bin/env bash

# federates the functionality of all my old dmenu_ scripts

if ! hash dmenu; then
  echo "dmenu must be installed to use $0! Please install and try again"
  exit 1
fi

source $(dirname $0)/common.sh
x11::assigndmenu

# set up common vars
if hash urxvt; then
  TERMINAL=urxvt
elif hash terminator; then
  TERMINAL=terminator
else
  TERMINAL=xterm
fi
PROMPT_CHAR='$'

dmenu::ranger() {
  WS=$(cat $HOME/.dirhist | $DMENU -p "dir$PROMPT_CHAR")
  if grep -q "$WS" $HOME/.dirhist ; then
    echo "Exists in history"
  else
    echo $WS >> $HOME/.dirhist
  fi
  [ "$WS" ] && $TERMINAL -e bash -c "ranger $WS"
}

dmenu::web() {
  WS=$(cat $HOME/.wshist | $DMENU -p "Open Site$PROMPT_CHAR")
  if grep -q "$WS" $HOME/.wshist ; then
    echo "Exists in history"
  else
    echo $WS >> $HOME/.wshist
  fi
  [ "$WS" ] && chromium "$WS"
}

usage() {
  echo "This script wraps dmenu with standard coloration"
  echo "and exposes functions useful for systems that do not have"
  echo "a desktop environment installed"
  echo
  echo "Usage: $0 <command>"
  echo "Where command is one of:"
  echo "    man: Man page chooser"
  echo "    playlist: MPC-based playlist selector"
  echo "    ranger: Launch a directory in the file manager ranger"
  echo "    web: Open a url"
  echo "    run: Provide dmenu_run functionality"
  exit 1
}

case $1 in
  man)
    page=$(cat $HOME/.cache/dmenu_run | $DMENU -p "Man$PROMPT_CHAR")
    $TERMINAL -e bash -c "man $page"
    ;;
  playlist)
    if ! hash mpc; then
      echo "playlist requires mpc to be installed!"
      exit 1
    fi
    SONG=$(mpc playlist | $DMENU -p "Song Name$PROMPT_CHAR" || echo ";;;")
    [ "$SONG" != ";;;" ] && mpc --no-status play $(sed -n "s@^ *\([0-9]\+\);$SONG@\1@p" < <(mpc playlist|nl -s ';'))
    ;;

  ranger)
    dmenu::ranger
    ;;
  ssh)
    if ! hash ssh; then
      echo "ssh requires ssh to be installed (holy redudancy Batman)"
      exit 1
    fi
    selected=$(awk '/^Host\ [a-zA-Z0-9\.]/{print $2}' $HOME/.ssh/config | $DMENU -p "ssh$PROMPT_CHAR")
    $TERMINAL -e bash -c "ssh $selected"
    ;;
  web)
    dmenu::web
    ;;
  run)
    $DMENUR -p "$(uname -n)$PROMPT_CHAR"
    ;;
  help|-h|--help|*)
    usage
    ;;
esac
