#!/usr/bin/env bash

# requirements check
if ! hash dzen2; then
  echo "dvol requires dzen2 to be installed, please install it."
  exit 1
fi

if hash gdbar 2>/dev/null; then
  BAR_PROGRAM=gdbar
elif hash dzen2-gdbar 2>/dev/null; then
  BAR_PROGRAM=dzen2-gdbar
else
  echo 'dvol requires gdbar from the dzen2 package to be installed'
  exit 1
fi

source $(dirname $0)/common.sh
x11::parsecolors

IF="Master"
SECS="1"
FONT='-*-fixed-medium-r-normal-*-16-*-*-*-*-*-iso8859-*'
BG="$color16"
FG="$color17"
XPOS="835"
YPOS="530"
WIDTH="500"
PIPE="/tmp/dvolpipe"
test -e $PIPE && rm $PIPE

err() {
  echo "$1"
  exit 1
}

usage() {
  echo "usage: dvol [option]"
  echo
  echo "Options:"
  echo "     -s, --show     - show the current song and volume"
  echo "     -i, --increase - increase volume by \`argument'"
  echo "     -d, --decrease - decrease volume by \`argument'"
  echo "     -t, --toggle   - toggle mute on and off"
  echo "     -h, --help     - display this"
  exit
}

#Argument Parsing
case "$1" in
  '-i'|'--increase')
    [ -z "$2" ] && err "No argument specified for increase."
    amixer set "$IF" "${2}%+" >/dev/null
    ;;
  '-d'|'--decrease')
    [ -z "$2" ] && err "No argument specified for decrease."
    amixer set "$IF" "${2}%-" >/dev/null
    ;;
  '-t'|'--toggle')
    amixer set "$IF" toggle >/dev/null
    ;;
	'-s'|'--show')
		;;
  '-h'|'--help'|*)
    usage
    ;;
esac

MUTED=$(amixer get "$IF" | awk '/dB/{print $NF}' | tr -d '[]' | uniq)
if [[ "$MUTED" == "off" ]]; then
  VOLUME=0
else
  VOLUME="$(amixer get "$IF" | awk '/dB/{print $5}' | tr -d '[]' | uniq)"
fi

#Using named pipe to determine whether previous call still exists
#Also prevents multiple volume bar instances
mkfifo "$PIPE"
(dzen2 -l 1 -x "$XPOS" -y "$YPOS" -w "$WIDTH" -fn "$FONT" -bg "$BG" -fg "$FG" -e 'onstart=uncollapse' < "$PIPE" 
 rm -f "$PIPE") &

# Feed the pipe!
if [[ "$(pgrep spotify)" ]]; then
	TRACK=$(dbus-send --print-reply --dest=org.mpris.MediaPlayer2.spotify /org/mpris/MediaPlayer2 org.freedesktop.DBus.Properties.Get string:'org.mpris.MediaPlayer2.Player' string:'Metadata' | grep -A 1 'xesam:title' | grep variant | sed 's/variant//g' | sed 's/string//g' | sed -e 's/^ *\"//g' -e 's/\" *$//g' -e 's/;$//g')
	#ARTIST=$(dbus-send --print-reply --dest=org.mpris.MediaPlayer2.spotify /org/mpris/MediaPlayer2 org.freedesktop.DBus.Properties.Get string:'org.mpris.MediaPlayer2.Player' string:'Metadata' | grep -A 2 'xesam:artist' | grep string | grep -v xesam | sed 's/string//g' | sed -e 's/^ *\"//g' -e 's/\" *$//g' -e 's/;$//g')
	STR="$TRACK"
else
	STR="Volume"
fi
(echo "[$MUTED] $STR" ; echo "$VOLUME" | $BAR_PROGRAM -w "$WIDTH" -fg "$FG" -bg "$BG" ; sleep "$SECS") > "$PIPE"
